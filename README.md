# Microservice Video Encoder

## Setting up environment

To run in development mode, follow these steps:

* Duplicate the `.env.example` file to` .env`
* Run the docker-compose up -d
* Access the rabbitmq administration and create a `fannout` type exchange. It will be a Dead Letter Exchange to receive messages that are not processed.
* Create a `Dead Letter Queue` and link it to the` Dead Letter Exchange` that has just been created. There is no need for routing_key.
* In the `.env` file, enter the name of the `Dead Letter Exchange` in the parameter: `RABBITMQ_DLX`
* Create a service account on GCP that has permission to write to google cloud storage. Download the json file with the credentials and save it to the project root exactly with the name: `bucket-credential.json`

## Running

To run the encoder, run the `make server` command directly on the container. Example:

```
docker exec encoder-new2_app_1 make server
```

Since `microservico-enconder_app_1` is the name of the container name generated by the docker-compose.

## Pattern of sending message to the encoder

For a message to be parsed by the encoder system, it must arrive in the following format in json:

```
{
  "resource_id": "my-resource-id-can-be-a-uuid-type",
  "file_path": "convite.mp4"
}
```

* `resource_id`: Represents the ID of the video you want to convert. It is of type string.
* `file_path`: It is the full path of the mp4 video inside the bucket.

## Encoder return message pattern

### Processing success

For each video processed, the encoder will send the result of the processing to an exchange (to be configured in the .env).

If processing has been completed successfully, the return pattern in json will be:

```
{
    "id":"bbbdd123-ad05-4dc8-a74c-d63a0a2423d5",
    "output_bucket_path":"bucket-path",
    "status":"COMPLETED",
    "video":{
        "encoded_video_folder":"b3f2d41e-2c0a-4830-bd65-68227e97764f",
        "resource_id":"aadc5ff9-0b0d-13ab-4a40-a11b2eaa148c",
        "file_path":"file-name.mp4"
    },
    "Error":"",
    "created_at":"2021-04-14T19:43:34.850479-04:00",
    "updated_at":"2021-04-14T19:43:38.081754-04:00"
}
```

The `encoded_video_folder` is the folder that contains the converted video.

### Processing error

If the processing has encountered an error, the return pattern in json will be:

```
{
    "message": {
        "resource_id": "aadc5ff9-010d-a3ab-4a40-a11b2eaa148c",
        "file_path": "file-name.mp4"
    },
    "error":"Motivo do erro"
}
```

In addition, the encoder will send the original message that there was a problem during processing to a dead letter exchange.
Just configure the desired DLX in the .env file in the parameter: `RABBITMQ_DLX`
